---
title: "analysis of Ontario COVID19 data"
author: "Ben Bolker, Michael Li, Jonathan Dushoff, David Earn (McMaster University)"
date: "`r format(Sys.time(),'%d %b %Y')`"
---

```{r opts, include=FALSE}
knitr::opts_chunk$set(echo=FALSE)
```

```{r pkgs,message=FALSE}
library(tidyverse)
library(glmmTMB)
library(nlme)
library(broom.mixed)
library(McMasterPandemic)
library(ggplot2);theme_set(theme_bw())
```


Reading data from Michael Li's [curated Canadian COVID data repository](https://wzmli.github.io/COVID19-Canada)
harvested from official sources such as [this](https://www.ontario.ca/page/2019-novel-coronavirus#section-0) and [hospitalization cumulative counts](http://wzmli.github.io/COVID19-Canada/PHO.csv) gather from [Public Health Ontario Epidemiological Summary](https://files.ontario.ca/moh-covid-19-report-en-2020-04-07.pdf).


```{r read_data,message=FALSE,warning=FALSE}
url <- "https://wzmli.github.io/COVID19-Canada/git_push/clean.Rout.csv"
dd <- read_csv(url)

PHOurl <- "http://wzmli.github.io/COVID19-Canada/PHO.csv"
ddPHO <- read_csv(PHOurl)

```


Let's warm up with a quadratic fit (changing scale in ggplot link function in GLMs) to reported cases in all provinces
```{r Canada_reported_case, message=FALSE,warning=FALSE,echo=FALSE}
print(gg0 <- ggplot(dd,aes(Date,newConfirmations,colour=Province))
    + geom_line(size=0.5,alpha=0.3)
    + geom_point()+scale_y_log10()
    + geom_smooth(method="lm",
                  formula=y~poly(x,2),
                  se=FALSE)
)

## easiest way to plot mixed model outputs with CIs?
## sjPlot, broom.mixed, ... ?

## data exploration and possible comparison of IDEA/IHME/etc. approaches
## (i.e. purely phenomenological)
## fit linear, quad mixed? models
## logit, Richards?
## epigrowthfit or mle2 or ... ?
## plot predictions and CIs

```


Ontario is the only province we have all three reported hospitlaization counts (hospitalization, ICU, ventilator). 

```{r ONdata_cleaning,message=FALSE,warning=FALSE}

ont_dd <- (dd
  %>% filter(Province=="ON")
  %>% select(Date,Hospitalization,ICU,Ventilator,deceased,newConfirmations)
  %>% pivot_longer(-Date,names_to="var")
)
```

```{r ONplot,message=FALSE, warning=FALSE}
print(gg1 <- ggplot(ont_dd,aes(Date,value,colour=var))
    + geom_point()
    + scale_y_log10()
    + geom_smooth(method="lm",
                  formula=y~poly(x,2))
)
```

- Natural for ICU and Ventilator to be parallel (no real lags here)
- recent nonlinearity/flattening in cases is too recent/sharp to affect the estimated slope much
- very weird that the ICU/vent curves are flattening before the other two

Picture is cleaner (and flattening is more apparent) if we focus on more recent data.

```{r ont_plot_recent, message=FALSE, warning=FALSE}
## find first useful day
min_day <- function(day,value) {
    good <- !is.na(value) & value>0
    if (all(good)) min(day) else min(day[good])
}

start_date <- "2020-03-15"

ont_recent <- (ont_dd
    %>% filter(Date>=as.Date(start_date))
    %>% mutate(day=as.numeric(Date-min(Date)))
    %>% group_by(var)
    %>% mutate(vday=day-min_day(day,value))
    %>% ungroup()
)
    
print(gg1 %+% ont_recent)
```

We want to find the first _useful/meaningful_ day for each variable and adjust the different time series to their respective meaningful day.

```{r ont_plot_shift, message=FALSE, warning=FALSE}

print(gg2 <- ggplot(ont_recent,aes(vday,value,colour=var))
    + geom_point()
    + scale_y_log10()
    + geom_smooth(method="lm",
                  formula=y~poly(x,2))
    + scale_x_continuous(limits=c(-1,NA))
)

```