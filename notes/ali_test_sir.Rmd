---
title: "SIR model with testing flows"
author: "Ali"
date: "15/08/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Notes on other references: (1) [testing_flow.md](testing_flow.md)(I am using the notation in this doc)

# On Math and Weighting

## Model and Definitions

- Assume there are 3 groups of individuals: $S$, $I$ and $R$.
- Each group splits into 4 subgroups to incorporate the testing mechanism, so overall the model framework has 12 compartments:
$S_u,$ $S_n$, $S_p$, $S_t$, $I_u$, $I_n$, $I_p$, $I_t$, $R_u$, $R_n$, $R_p$, $R_t$.

**BMB**: yes, except that (1) two of the compartments are unnecessary (if we assume a perfectly specific test, i.e. no false positives, then $S_p$ and $S_t$ are always zero (2) we will want two 'integrator' or 'accumulator' compartments, $N$ and $P$, to collect cumulative reported neg/pos tests. 

**AGh**: Is this correct for $N$ and $P$? $dN/dt = S_n + I_n + R_n$ and $dP/dt = S_p + I_p + R_p$.

**BMB**: no, they're missing an $\omega$: $dN/dt = \omega(S_n + I_n + R_n)$, $dP/dt = \omega(S_p + I_p + R_p)$. (And $S_p$ is always zero so you could omit it.)

## Per Capita Rate of Flow from Untested to Positive or Negative Compartments

Let's look at the flow from a particular untested compartment, $Z_i$, to a particular tested awaiting for a negative test. The equation is $$\frac{d Z_i}{dt} = - f_i Z_i,$$
 where $f_i$, is the per capita rate of flow, with the dimension of $\frac{1/time}{\#}$, where by # I mean population number.
 
1. How to define $f_i$ as a function of *testing intensity*, $t$ and *weights*, $\omega_i$.
Checkings:
- $t$ is fixed and is a parameter of the model, it is given through the reported information, dimension of $t$ is $\#/time$. (**BMB**: no, $t$ has dimensions of $1/time$)
- $\omega_i$ is a weight:
(i) $\frac{\omega_i}{\sum_j \omega_j} \times \frac{Z_i/I_u}{\sum_j Z_j}$, where $I_u$ is untested people in compartment $I$. **BMB**: no, $\omega$ is the rate of *onward flow* from the $p$ compartment to $t$, or from $n$ back to $u$.  It has units of $1/time$.

The complicated part is the flow rate from $Z_u$ to $Z_n$, $Z_p$.  The (total, not per capita) flow from $Z_u$ to $Z_n$ is $(1-P_Z) F(W_Z) Z_u, from $Z_u$ to $Z_p$ is $P_Z F(W_Z) Z_u$.  At the simplest $F(W_Z)=W_Z$.  The flows from $Z_n$ to $Z_u$ and $Z_p$ to $Z_t$ are $\omega Z_n$ and $\omega Z_p$ respectively.

**BMB**: We have gone back to using a scaling where $F(W_Z) = (W_Z \cdot N)/\sum_{Z'} \left( W_{Z'} {Z'}_{u} \right)$, i.e. the denominator is the sum of the product of the weights and the current occupancy of the untested compartments.


## Model

![](../inst/pix/sir_test1.jpg)

\begin{align}
1)\  d S_u/dt &= \omega_{S_n} S_n -\beta \frac{(I_u+I_n+I_p+I_t)}{N0} S_u - f_{S_u} S_u \\
2)\ d S_n/dt &= f_{S_u} S_u - \omega_{S_n} S_n \\
3)\ d I_u/dt &= \beta \frac{(I_u+I_n+I_p+I_t)}{N0} S_u + \omega_{I_n} I_n - f_{I_u} (1-P_{I_u}) I_u -f_{I_u} P_{I_u} I_u- \gamma I_u  \\
4)\ d I_n/dt &= f_{I_u} (1-P_{I_u}) I_u - \omega_{I_n} I_n \\
5)\ d I_p/dt &= f_{I_u} P_{I_u} I_u - \omega_{I_p} I_p \\
6)\ d I_t/dt &= \omega_{I_p} I_p - \gamma I_t  \\
7)\ d R_u/dt &= \gamma I_u + \omega_{R_n} R_n - f_{R_u} (1-P_{R_u}) R_u -f_{R_u} P_{R_u}) R_u  \\
8)\ d R_n/dt &= f_{R_u} (1-P_{R_u}) R_u - \omega_{R_n} R_n  \\
9)\ d R_p/dt &= f_{R_u} P_{R_u}) R_u - \omega_{R_p} R_p  \\
10)\ d R_t/dt &= \gamma I_t + \omega_{R_p} R_p  \\
11)\ dN/dt &= S_n + I_n + R_n   \\
12)\ dP/dt &= S_p + I_p + R_p.
\end{align}

**BMB**: 

* we don't need the $u$ subscripts on $f_Z$, I think
* similarly, $\omega=\omega_{Z_n} = \omega_{Z_p}$ is a pretty safe assumption, i.e. that tests get returned at the same rate (on average) regardless of who they were sampled from, and especially whether they were positive or negative
* similarly we don't need $u$ subscripts on $P_I$
* there should be flows of $\gamma I_n$, $\gamma I_p$ from $I_n \to R_n$ and $I_p \to R_p$
* in general you should make sure that the population is conserved!

Let $t$ be testing intensity (1/time), $W = (W_1,W_2,W_3)$ be weighting vector which distributes the testing intensity for $S_u$, $I_u$ and $R_u$. Then
Is this right way of thinking?

$f_{S_u} = t \frac{W_1}{\sum_i W_i}$,
$f_{I_u} = t \frac{W_2}{\sum_i W_i}$,
$f_{R_u} = t \frac{W_3}{\sum_i W_i}$.

**BMB:** no. Multiplying by $t$ is correct, but see my comment right about the "model" section. Your $f_{Z_u}$ is my $F(W_Z)/t$.

```{r, packages}
require(deSolve)
require(ggplot2)
require(tidyr)
```

```{r, model formulation}
sir.model <- function(t,x,params){
    ## BMB: better to do this with with(c(as.list(x),as.list(params)) { ... }
    ## *or* unpack(c(as.list(x),as.list(params))); unpacking every element
    ## is both clunky and fragile (depends  on order of vectors)
  ## extract the state variables
  Su <- x[1]
  Sn <- x[2]
  Iu <- x[3]
  In <- x[4]
  Ip <- x[5]
  It <- x[6]
  Ru <- x[7]
  Rn <- x[8]
  Rp <- x[9]
  Rt <- x[10]
  N <- x[11]
  P <- x[12]
  
  ## extract the parameters
  N0 <- params["N0"] #initial population size
  beta <- params["beta"] #transition rate
  gamma <- params["gamma"] #recovery rate
  t <- params["t"] #testing intensity
  
  ## BMB: new code will go here?
    
  ## the model equations
  dS.dt <- -beta*S*I/N
  dI.dt <- beta*S*I/N-gamma*I
  dR.dt <- gamma*I
  ## combine results into a single vector
  dxdt <- c(dS.dt,dI.dt,dR.dt)
  ## return result as a list!
  list(dxdt)
}


```










